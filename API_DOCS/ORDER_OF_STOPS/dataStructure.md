# Sublymus System Documentation

## Order Structure Detailed Reference

This document describes the core data structure used across the Sublymus delivery platform, specifically for the **Universal Order Workflow** (Steps -> Stops -> Actions).

### 1. Request Payload (Order Creation)
When creating an order via `POST /v1/orders`, the server expects the following hierarchical structure.

```json
{
    "steps": [
        {
            "sequence": 0,
            "linked": true, // If true, next steps are forced to the same mission/driver
            "stops": [
                {
                    "address_text": "123 Rue de Rivoli, Paris",
                    "coordinates": [48.8566, 2.3522], // [lat, lng]
                    "sequence": 0,
                    "actions": [
                        {
                            "type": "pickup | delivery | service",
                            "transit_item_id": "item_abc_123", // Reference to root-level transit_items
                            "quantity": 1, 
                            "service_time": 600, // Seconds (e.g., 10 min = 600s)
                            "confirmation_rules": {
                                "photo": [
                                    {
                                        "name": "Photo du colis",
                                        "pickup": true,
                                        "delivery": false,
                                        "compare": false,
                                        "reference": null
                                    },
                                    {
                                        "name": "Signature client",
                                        "pickup": false,
                                        "delivery": true,
                                        "compare": false,
                                        "reference": null
                                    }
                                ],
                                "code": [
                                    {
                                        "name": "OTP Client",
                                        "pickup": false,
                                        "delivery": true,
                                        "compare": true,
                                        "reference": "123456" // Generated by server or provided
                                    }
                                ]
                            },
                            "metadata": {
                                "productName": "iPhone 15",
                                "client": { "name": "Noga", "phone": "..." }
                            }
                        }

                    ]
                }
            ]
        }
    ],
    "transit_items": [
        {
            "id": "item_abc_123", // Local temporary ID for mapping actions
            "product_id": "PROD-101", // Optional link to catalog
            "name": "iPhone 15",
            "description": "Black, 128GB",
            "packaging_type": "box | fluid",
            "weight_g": 500,
            "volume_l": 0.5, // For fluid items (liters)
            "dimensions": {
                "width_cm": 15,
                "height_cm": 10,
                "length_cm": 2
            },
            "unitary_price": 999,
            "requirements": ["froid", "fragile"], // Special handling: froid | fragile | dangerous | sec
            "type_product": ["electronic"], // Product type: liquide | poudre | papier | food | electronic | other
            "metadata": {}
        }
    ],
    "ref_id": "EXT-ORD-001",
    "assignment_mode": "GLOBAL | INTERNAL | TARGET",
    "priority": "LOW | MEDIUM | HIGH",
    "optimize_route": true,
    "allow_overload": false,
    "metadata": {}
}
```

### 2. Response Structure (Serialized Order)
When retrieving an order via `GET /v1/orders/:id`, the server returns a fully hydrated object.

```json
{
    "id": "ord_xxx",
    "status": "PENDING | ACCEPTED | ...",
    "refId": "...",
    "clientId": "usr_xxx",
    "driverId": "usr_yyy",
    "vehicleId": "vh_zzz",
    "assignmentMode": "GLOBAL",
    "totalDistanceMeters": 5400,
    "totalDurationSeconds": 1200,
    "routeGeometry": { "type": "LineString", "coordinates": [...] },
    "pricingData": { "total_price": 25.5, ... },
    "statusHistory": [
        { "status": "PENDING", "timestamp": "ISO-DATE", "note": "..." }
    ],
    "steps": [
        {
            "id": "stp_xxx",
            "sequence": 0,
            "linked": true,
            "stops": [
                {
                    "id": "st_xxx",
                    "address_text": "...",
                    "coordinates": [...],
                    "sequence": 0,
                    "actions": [
                        {
                            "id": "act_xxx",
                            "type": "PICKUP",
                            "status": "PENDING",
                            "transitItemId": "tri_xxx",
                            "serviceTime": 600,
                            "confirmationRules": { ... },
                            "metadata": { ... }
                        }
                    ]
                }
            ]
        }
    ],
    "transitItems": [
        {
            "id": "tri_xxx",
            "name": "...",
            "currentQuantity": 1,
            "packagingType": "box"
        }
    ]
}
```

---

## Technical Specifications

### 1. Time Units
- **Payload (Input)**: `service_time` is in **seconds**.
- **Frontend**: The dashboard UI handles minutes for user convenience, but multiplies by **60** before sending to the server.
- **Model (Output)**: `serviceTime` (serialized as `serviceTime`) remains in seconds.

### 2. Hierarchy vs Geometry
- **Hierarchy (Structural)**: Steps, Stops, and Actions define the *business logic* of the order.
- **OrderLegs (Geometric)**: Legs are child entities of the Order that store the calculated path (polyline) and distances between specific coordinates in the optimized sequence.

### 3. Action Logic Patterns
- **PICKUP (+)**: Increases the vehicle load for the associated `transit_item_id`.
- **DELIVERY (-)**: Decreases the vehicle load. The server validates that a delivery action cannot exceed the current pickup quantity for that item ID.
- **SERVICE (.)**: Geometric stop without load variation (e.g., installation, maintenance). `quantity` is forced to 0.

### 4. Assignment Modes
- **GLOBAL**: Order is available to the entire public pool of drivers in the zone.
- **INTERNAL**: Reserved for the company's private fleet.
- **TARGET**: Specifically assigned to a `driverId` (Direct Offer).

### 5. Shadow Components (Draft-in-Place)
To support real-time modifications without disrupting the driver's flow, Sublymus uses a **Shadow Component** (cloning) mechanism.

| Flag | Description |
| :--- | :--- |
| `is_pending_change` | If `true`, this is a "working copy" (shadow). Hidden from Drivers, visible to Clients. |
| `is_delete_required` | If `true`, the original record is marked for deletion. It disappears from the Client view but remains for the Driver until merged. |
| `original_id` | Links a shadow component back to its stable original. |

- **State Management**: Modifying a non-draft order creates a clone of the Step/Stop/Action with `is_pending_change: true`.
- **Merging**: Calling `POST /v1/orders/:id/push-updates` validates the virtual state and merges shadows into originals, deleting the shadow records.
- **Relinking**: During merge, child entities are automatically re-attached to the original parents.

